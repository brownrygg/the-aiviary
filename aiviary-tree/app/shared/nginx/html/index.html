<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Aiviary - Connect</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Lora:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Palette: 'Sky to Earth' */
            --bg-gradient-start: #C2E0FF;
            --bg-gradient-end: #F7F5F0;
            
            --text-main: #2C3333;
            --text-muted: #6B7C85;
            
            --brand-primary: #2C4A52;     /* Deep Atmospheric Teal */
            --brand-accent: #BF5B28;      /* Burnt Clay */
            --brand-accent-hover: #A64D21;

            --border-color: rgba(44, 74, 82, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(180deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 80px 20px;
        }

        .layout-wrapper {
            width: 100%;
            max-width: 720px;
        }

        /* Header Section */
        header {
            text-align: center;
            margin-bottom: 50px;
        }

        h1 {
            font-family: 'Lora', serif;
            font-weight: 500;
            font-size: 3.5rem;
            color: var(--brand-primary);
            letter-spacing: -0.03em;
            margin-bottom: 8px;
        }

        .subtitle {
            font-family: 'Lora', serif;
            font-style: italic;
            font-size: 1.125rem;
            color: var(--text-muted);
            margin-bottom: 24px;
        }

        /* Toggles (Global) */
        details {
            cursor: pointer;
        }

        summary {
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--brand-primary);
            list-style: none;
            position: relative;
            padding-right: 18px;
            display: inline-block;
            transition: color 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.8;
        }

        summary:hover {
            color: var(--brand-accent);
            opacity: 1;
        }

        summary::-webkit-details-marker {
            display: none;
        }

        summary::after {
            content: '';
            position: absolute;
            right: 0;
            top: 4px;
            width: 6px;
            height: 6px;
            border-right: 2px solid currentColor;
            border-bottom: 2px solid currentColor;
            transform: rotate(45deg);
            transition: transform 0.2s ease;
        }

        details[open] summary::after {
            transform: rotate(-135deg) translate(-2px, -2px);
        }

        /* Header About Toggle Specifics */
        header details {
            margin: 0 auto;
            max-width: 480px;
        }
        
        header .toggle-content {
            font-family: 'Lora', serif;
            font-size: 1rem;
            line-height: 1.6;
            color: var(--text-muted);
            margin-top: 12px;
            font-style: italic;
            animation: slideDown 0.3s ease-out;
            text-align: center;
        }

        /* Category Toggle Specifics */
        .category-toggle {
            margin-bottom: 24px;
        }

        .category-toggle .toggle-content {
            font-family: 'Inter', sans-serif; /* Clean sans for technical details */
            font-size: 0.9rem;
            line-height: 1.5;
            color: var(--text-muted);
            margin-top: 12px;
            background: rgba(44, 74, 82, 0.03);
            padding: 16px;
            border-radius: 8px;
            border-left: 3px solid var(--brand-primary);
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* List Section - Glass Effect */
        .glass-panel {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.9);
            padding: 40px;
            box-shadow: 
                0 4px 20px rgba(44, 74, 82, 0.05),
                0 0 0 1px rgba(255, 255, 255, 0.5) inset;
        }

        /* Categories */
        .category-header {
            font-family: 'Lora', serif;
            font-size: 1.25rem;
            color: var(--brand-primary);
            margin-bottom: 12px; /* Reduced to sit closer to toggle */
            padding-bottom: 0;
            border-bottom: none;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .category-section {
            border-bottom: 1px solid rgba(44, 74, 82, 0.1);
            padding-bottom: 32px;
        }

        .category-section:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .category-section + .category-section {
            margin-top: 32px;
        }

        .service-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 0;
            border-top: 1px solid var(--border-color); /* Separator between items */
            transition: all 0.3s ease;
        }

        .service-item:first-of-type {
            border-top: 1px solid var(--border-color); /* Start list with border */
        }

        .service-item.disabled {
            opacity: 0.5;
            filter: grayscale(100%);
            pointer-events: none;
        }

        .service-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .service-details h3 {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
            color: var(--brand-primary);
        }

        .service-details p {
            font-size: 0.875rem;
            color: var(--text-muted);
            max-width: 380px;
            line-height: 1.5;
        }

        /* Actions */
        .btn {
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            font-size: 0.875rem;
            padding: 8px 20px;
            border-radius: 4px;
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
        }

        .btn-connect {
            background-color: var(--brand-accent);
            color: white;
            box-shadow: 0 4px 12px rgba(191, 91, 40, 0.25);
            white-space: nowrap;
        }

        .btn-connect:hover {
            background-color: var(--brand-accent-hover);
            transform: translateY(-1px);
        }

        .status-badge {
            font-family: 'Lora', serif;
            font-style: italic;
            font-size: 0.9rem;
            color: var(--text-muted);
            opacity: 0.8;
            white-space: nowrap;
        }

        .status-badge.connected {
            color: var(--brand-primary);
            font-style: normal;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            opacity: 1;
        }

        .status-badge.connected::before {
            content: '';
            display: block;
            width: 6px;
            height: 6px;
            background-color: var(--brand-primary);
            border-radius: 50%;
            box-shadow: 0 0 0 4px rgba(44, 74, 82, 0.1);
        }

        /* Footer */
        .main-action {
            margin-top: 60px;
            text-align: center;
        }

        .btn-launch {
            display: inline-block;
            font-family: 'Lora', serif;
            font-size: 1.25rem;
            color: var(--brand-primary);
            text-decoration: none;
            border-bottom: 1px solid rgba(44, 74, 82, 0.3);
            padding-bottom: 4px;
            opacity: 0.4;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .btn-launch.active {
            opacity: 1;
            pointer-events: auto;
            border-bottom-color: var(--brand-accent);
        }

        .btn-launch:hover {
            color: var(--brand-accent);
        }

        .launch-note {
            margin-top: 16px;
            font-size: 0.9rem;
            color: var(--text-muted);
            font-style: italic;
        }

        @media (max-width: 600px) {
            h1 { font-size: 2.5rem; }
            .glass-panel { padding: 30px 20px; }
            .service-item { flex-direction: column; align-items: flex-start; gap: 16px; }
            .service-action { align-self: flex-start; margin-left: 0; }
        }
    </style>
</head>
<body>

    <div class="layout-wrapper">
        <header>
            <h1>The Aiviary</h1>
            <p class="subtitle">Integration Manifest</p>
            
            <details>
                <summary>About the Nest</summary>
                <div class="toggle-content">
                    The Aiviary is a decentralized ecosystem for content automation. This nest serves as the central hub where social streams and workspace tools converge, allowing your digital agents to observe, analyze, and act on your behalf.
                </div>
            </details>
        </header>

        <div class="glass-panel" id="services-container">
            <!-- Injected by JS -->
        </div>

        <div class="main-action">
            <a href="#" class="btn-launch" id="launch-btn">Proceed to Nest &rarr;</a>
            <p class="launch-note" id="launch-note">Establish a connection to proceed.</p>
        </div>
    </div>

    <script>
        // Configuration - Update these per client deployment
        const OAUTH_BROKER_URL = 'https://oauth.theaiviary.com';
        // CLIENT_ID is derived from hostname (e.g., clienta.rikkcontent.com -> clienta)
        const CLIENT_ID = window.location.hostname.split('.')[0];
        const CHAT_DOMAIN = window.location.hostname.replace(/^([^.]+)/, 'chat.$1');

        const SERVICES = [
            // Social Channels
            { id: 'meta', category: 'social', name: 'Meta / Instagram', description: 'Business portfolio and audience insights.', enabled: true },
            { id: 'tiktok', category: 'social', name: 'TikTok', description: 'Short-form video metrics.', enabled: false },
            { id: 'youtube', category: 'social', name: 'YouTube', description: 'Channel performance.', enabled: false },
            { id: 'linkedin', category: 'social', name: 'LinkedIn', description: 'Professional network data.', enabled: false },
            
            // Workspace Tools
            { id: 'google', category: 'workspace', name: 'Google Workspace', description: 'Mail and Drive resources.', enabled: false },
            { id: 'asana', category: 'workspace', name: 'Asana', description: 'Task flow synchronization.', enabled: false },
            { id: 'monday', category: 'workspace', name: 'Monday.com', description: 'Project tracking.', enabled: false },
            { id: 'slack', category: 'workspace', name: 'Slack', description: 'Team communications.', enabled: false }
        ];

        let connectionStatus = {};

        function renderServices() {
            const container = document.getElementById('services-container');
            container.innerHTML = '';

            const categories = {
                social: { 
                    title: 'Social Channels', 
                    description: 'Connecting these streams activates the Nestâ€™s observational core. All content is automatically archived, indexed, and analyzed. This enables your agents to surface deep engagement insights, generate data-backed content strategies, and recall specific media or concepts instantly.',
                    items: [] 
                },
                workspace: { 
                    title: 'Workspace Tools', 
                    description: 'Linking these tools empowers your agents with direct agency. It activates secure MCP (Model Context Protocol) bridges, allowing your digital workforce to read documentation, manage tasks, and coordinate workflows within your existing ecosystem.',
                    items: [] 
                }
            };

            // Group services
            SERVICES.forEach(service => {
                if (categories[service.category]) {
                    categories[service.category].items.push(service);
                }
            });

            // Render categories
            Object.values(categories).forEach(cat => {
                const section = document.createElement('div');
                section.className = 'category-section';

                // Header
                const header = document.createElement('h2');
                header.className = 'category-header';
                header.textContent = cat.title;
                section.appendChild(header);

                // Capability Toggle
                const toggle = document.createElement('details');
                toggle.className = 'category-toggle';
                toggle.innerHTML = `
                    <summary>Intelligence Capabilities</summary>
                    <div class="toggle-content">
                        ${cat.description}
                    </div>
                `;
                section.appendChild(toggle);

                // Service Items
                cat.items.forEach(service => {
                    const isConnected = connectionStatus[service.id] === true;
                    const item = document.createElement('div');
                    item.className = `service-item ${!service.enabled ? 'disabled' : ''}`;
                    
                    let actionHtml;
                    if (service.enabled) {
                        if (isConnected) {
                            actionHtml = `<span class="status-badge connected">Active</span>`;
                        } else {
                            actionHtml = `<button class="btn btn-connect" onclick="connectService('${service.id}')">Connect</button>`;
                        }
                    } else {
                        actionHtml = `<span class="status-badge">Planned</span>`;
                    }

                    item.innerHTML = `
                        <div class="service-info">
                            <div class="service-details">
                                <h3>${service.name}</h3>
                                <p>${service.description}</p>
                            </div>
                        </div>
                        <div class="service-action">
                            ${actionHtml}
                        </div>
                    `;
                    section.appendChild(item);
                });

                container.appendChild(section);
            });
        }

        async function checkAllStatus() {
            try {
                const response = await fetch('/api/credentials/status');
                if (response.ok) {
                    const data = await response.json();
                    connectionStatus = data.platforms || {};
                    renderServices();
                    updateLaunchButton();
                }
            } catch (e) {
                console.error('Status check failed', e);
            }
        }

        function updateLaunchButton() {
            const btn = document.getElementById('launch-btn');
            const note = document.getElementById('launch-note');
            const hasConnection = Object.values(connectionStatus).some(status => status === true);

            if (hasConnection) {
                btn.classList.add('active');
                btn.href = `https://${CHAT_DOMAIN}`;
                note.textContent = 'Data streams ready.';
                note.style.opacity = '0.7';
            } else {
                btn.classList.remove('active');
                btn.href = '#';
                note.textContent = 'Establish a connection to proceed.';
            }
        }

        function connectService(platformId) {
            const service = SERVICES.find(s => s.id === platformId);
            if (service && service.enabled) {
                window.location.href = `${OAUTH_BROKER_URL}/auth/${platformId}?client_id=${CLIENT_ID}`;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderServices();
            checkAllStatus();
            setInterval(checkAllStatus, 15000);
        });
    </script>
</body>
</html>
