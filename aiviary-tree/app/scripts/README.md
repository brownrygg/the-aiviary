# Token Usage Analytics Script

## Quick Start

From the `content-nest` directory:
```bash
./token-usage.sh
```

Or from the `content-nest/app` directory:
```bash
./scripts/token-usage.sh
```

## Features

The script provides an interactive menu with the following options:

### 1. Recent Usage (Last 10 queries)
Shows the most recent API calls with token counts, cost, and query preview.

### 2. Daily Summary (Last 7 days)
Aggregated statistics by day for the last week.

### 3. Daily Summary (Last 30 days)
Aggregated statistics by day for the last month.

### 4. Monthly Stats (Last 30 days)
Overall statistics including:
- Total requests
- Total tokens (input/output)
- Average tokens per request
- Tool calls
- Estimated cost

### 5. Top 10 Most Expensive Queries
Identifies which queries consumed the most tokens and cost the most.

### 6. Prompt Caching Performance
Shows how effective prompt caching is:
- Cache hit rate
- Total tokens saved
- Cost savings from caching

### 7. Hourly Breakdown (Today)
Shows usage patterns by hour for the current day.

### 8. Export to CSV
Exports all token usage data to a CSV file for external analysis.

### 9. Custom Query
Allows you to specify custom date ranges and limits.

## Example Output

```
╔════════════════════════════════════════════════════════╗
║         Claude API Token Usage Analytics              ║
╚════════════════════════════════════════════════════════╝

Recent Token Usage (Last 10 Queries)

 time     | model_name              | input | output | total | cache_hits | tools | cost     | query
----------+-------------------------+-------+--------+-------+------------+-------+----------+------------------------------------------
 01-04... | claude-sonnet-4-202...  | 2145  | 342    | 2487  | 1850       | 2     | $0.0162  | which were my highest performing image...
```

## Understanding the Data

- **input**: Tokens sent to Claude (prompt + context)
- **output**: Tokens generated by Claude (response)
- **total**: Sum of input + output tokens
- **cache_hits**: Tokens read from prompt cache (90% discount!)
- **tools**: Number of tool use iterations (hybrid_search, etc.)
- **cost**: Estimated USD cost based on current pricing

## Cost Breakdown (Claude Sonnet 4 - Jan 2025)

- Input tokens: $3 per million
- Output tokens: $15 per million
- Cache creation: $3.75 per million
- Cache reads: $0.30 per million (90% discount!)

## Tips for Cost Optimization

1. **Monitor cache hit rate** - Higher cache hits = lower costs
2. **Check tool calls** - Multiple iterations increase cost
3. **Review expensive queries** - Optimize prompts that use lots of tokens
4. **Track daily trends** - Identify usage spikes

## Database Access

For direct database queries:
```bash
docker compose exec postgres psql -U postgres-non-root -d analytics

# View raw data
SELECT * FROM token_usage_log ORDER BY timestamp DESC LIMIT 10;

# Use pre-built views
SELECT * FROM daily_token_usage;

# Use helper functions
SELECT * FROM get_token_usage_stats('client', 30);
```

## Troubleshooting

**Error: Must run from directory containing docker-compose.yml**
- Make sure you're in `/content-nest` or `/content-nest/app` directory

**No data showing**
- Token logging started after the script was deployed
- Ask the analytics agent a question to generate data

**Permission denied**
- Make sure script is executable: `chmod +x token-usage.sh`
